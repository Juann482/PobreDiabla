<!-- ======================= -->
<!--       HEAD              -->
<!-- ======================= -->

<head th:fragment="head">

	<meta charset="utf-8">
	<title>Shame</title>
	<meta content="width=device-width, initial-scale=1.0" name="viewport">

	<link th:href="@{/images/Logo.png}" rel="icon">

	<!-- Google Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap"
		rel="stylesheet">

	<!-- Icons -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

	<!-- Libraries -->
	<link th:href="@{/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet">
	<link th:href="@{/lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css}" rel="stylesheet" />

	<!-- Bootstrap -->
	<link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">

	<!-- Template Styles -->
	<link th:href="@{/css/style.css}" rel="stylesheet">
	<link th:href="@{/css/brillos.css}" rel="stylesheet">

	<style>
		.center {
			justify-content: center;
			text-align: center;
		}

		.fade {
			transition: opacity 0.25s ease-in-out;
			opacity: 1;
		}

		.fade.hide {
			opacity: 0;
		}

		.debug-border {
			border: 2px solid red !important;
		}

		.debug-visible {
			opacity: 1 !important;
			display: table-row !important;
		}
	</style>

</head>

<!-- ======================= -->
<!--       SPINNER           -->
<!-- ======================= -->
<div th:fragment="spinner">
	<div id="spinner"
		class="show bg-dark position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
		<div class="spinner-border text-info" style="width: 3rem; height: 3rem;" role="status"></div>
	</div>
</div>

<!-- ======================= -->
<!--       SIDEBAR           -->
<!-- ======================= -->
<div th:fragment="sidebar">
	<div class="sidebar pe-4 pb-3">
		<nav class="navbar bg-secondary navbar-dark">

			<a th:href="@{/usuario/Dashboard}" class="navbar-brand mx-4 mb-3 d-flex align-items-center">
				<img class="rounded-circle" th:src="@{/images/Logo.png}" alt="Logo" style="width: 40px; height: 40px;">
				<h3 class="text-danger"> Shame</h3>
			</a>

			<div class="d-flex align-items-center ms-4 mb-4">
				<div class="position-relative">
					<img class="rounded-circle" th:src="@{/img/user.jpg}" alt="" style="width: 40px; height: 40px;">
					<div
						class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1">
					</div>
				</div>
				<div class="ms-3">
					<h6 class="mb-0">Juanito</h6>
					<span>Admin</span>
				</div>
			</div>

			<div class="navbar-nav w-100">
				<a th:href="@{/}" class="nav-item nav-link active">
					<i class="fa fa-tachometer-alt me-2"></i>Dashboard
				</a>

				<div class="nav-item dropdown">
					<a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
						<i class="fa fa-laptop me-2"></i>Actividad
					</a>
					<div class="dropdown-menu bg-transparent border-0">
						<a th:href="@{/usuario/Juegos}" class="dropdown-item">Juegos</a>
						<a th:href="@{/usuario/Personajes}" class="dropdown-item">Personajes</a>
						<a th:href="@{/usuario/Correos}" class="dropdown-item">Correos</a>
					</div>
				</div>

				<div class="nav-item dropdown">
					<a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
						<i class="fa fa-laptop me-2"></i>Formularios
					</a>
					<div class="dropdown-menu bg-transparent border-0">
						<a th:href="@{/usuario/JuegosRegistro}" class="dropdown-item">Registro de juegos</a>
						<a th:href="@{/usuario/PersonajeRegistro}" class="dropdown-item">Registro de personajes</a>
					</div>
				</div>
			</div>

		</nav>
	</div>
</div>

<!-- ======================= -->
<!--   NAVBAR                -->
<!-- ======================= -->
<div th:fragment="navbar">
	<nav class="navbar navbar-expand bg-secondary navbar-dark sticky-top px-4 py-0">
		<a href="index.html" class="navbar-brand d-flex d-lg-none me-4">
			<h2 class="text-info mb-0"><i class="fa fa-user-edit"></i></h2>
		</a>
		<a href="#" class="sidebar-toggler flex-shrink-0">
			<i class="fa fa-bars"></i>
		</a>

		<form class="d-none d-md-flex ms-4">
			<input class="form-control bg-dark border-0" type="search" placeholder="Buscar">
		</form>

		<div class="navbar-nav align-items-center ms-auto">

			<div class="nav-item dropdown">
				<a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
					<i class="fa fa-envelope me-lg-2"></i>
					<span class="d-none d-lg-inline-flex">Mensajes</span>
				</a>
				<div class="dropdown-menu dropdown-menu-end bg-secondary border-0 rounded-0 rounded-bottom m-0">
					<a href="#" class="dropdown-item">
						<div class="d-flex align-items-center">
							<img class="rounded-circle" src="img/user.jpg" alt="" style="width: 40px; height: 40px;">
							<div class="ms-2">
								<h6 class="fw-normal mb-0">Jhon send you a message</h6>
								<small>15 minutes ago</small>
							</div>
						</div>
					</a>
					<hr class="dropdown-divider">

					<a href="#" class="dropdown-item text-center">See all messages</a>
				</div>
			</div>

			<div class="nav-item dropdown">
				<a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
					<i class="fa fa-bell me-lg-2"></i>
					<span class="d-none d-lg-inline-flex">Notificaciones</span>
				</a>
				<div class="dropdown-menu dropdown-menu-end bg-secondary border-0 rounded-0 rounded-bottom m-0">

					<a href="#" class="dropdown-item text-center">Ver todas</a>

				</div>
			</div>

		</div>
	</nav>
</div>

<!-- ======================= -->
<!--   FOOTER                -->
<!-- ======================= -->
<div th:fragment="footer">
	<div class="container-fluid pt-4 px-4">
		<div class="bg-secondary rounded-top p-4">
			<div class="row">
				<div class="col-12 col-sm-6 text-center text-sm-start">
					&copy; <a href="#">Shame</a>, Todos los derechos reservados.
				</div>
				<div class="col-12 col-sm-6 text-center text-sm-end">
					Dise√±ado por: An√≥nimo<br>
					Distribuido por ThemeWagon
				</div>
			</div>
		</div>
	</div>
</div>

<!-- ======================= -->
<!--   JS FILES              -->
<!-- ======================= -->
<div th:fragment="jsFiles">

	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

	<script th:src="@{/lib/chart/chart.min.js}"></script>
	<script th:src="@{/lib/easing/easing.min.js}"></script>
	<script th:src="@{/lib/waypoints/waypoints.min.js}"></script>
	<script th:src="@{/lib/owlcarousel/owl.carousel.min.js}"></script>
	<script th:src="@{/lib/tempusdominus/js/moment.min.js}"></script>
	<script th:src="@{/lib/tempusdominus/js/moment-timezone.min.js}"></script>
	<script th:src="@{/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js}"></script>

	<!-- Template Javascript -->
	<script th:src="@{/js/main.js}"></script>


	<!-- ========================== -->
	<!--  üî• MOSTRAR DETALLES       -->
	<!-- ========================== -->
	<script>
		function mostrarDetalles(btn) {

			const nombre = btn.dataset.nombre;
			const img = btn.dataset.img;
			const calificacion = btn.dataset.calificacion;
			const juego = btn.dataset.juego;
			const puesto = parseInt(btn.dataset.puesto);
			const descripcion = btn.dataset.descripcion;

			let colorClass = "";
			let imgGlow = "";

			if (puesto === 1) {
				colorClass = "text-oro";
				imgGlow = "brillo-img-oro";
			} else if (puesto === 2) {
				colorClass = "text-plata";
				imgGlow = "brillo-img-plata";
			} else if (puesto === 3) {
				colorClass = "text-bronce";
				imgGlow = "brillo-img-bronce";
			} else if (puesto <= 10) {
				colorClass = "text-verde";
				imgGlow = "brillo-img-verde";
			}

			document.getElementById("modalNombre").textContent = nombre;
			document.getElementById("modalNombre").className = colorClass;

			const imgTag = document.getElementById("modalImg");
			imgTag.src = img;
			imgTag.className = "rounded-circle img-fluid";
			if (imgGlow) imgTag.classList.add(imgGlow);

			document.getElementById("modalPuesto").textContent = puesto + "¬∞";
			document.getElementById("modalPuesto").className = colorClass;

			document.getElementById("modalCalificacion").innerHTML = "‚≠ê".repeat(calificacion);
			document.getElementById("modalJuego").textContent = juego;
			document.getElementById("modalDescripcion").textContent = descripcion;

			new bootstrap.Modal(document.getElementById("DetallesPersonajes")).show();
		}
	</script>


	<!-- ========================== -->
	<!--  üî• FILTRO + AJAX         -->
	<!-- ========================== -->
	<div th:fragment="EfectosPersonajes">
		<script>
			let debounceTimer;

			document.querySelectorAll('#fNombre, #fJuego, #fPuesto, #fEstrellas')
				.forEach(input => input.addEventListener('input', function () {

					clearTimeout(debounceTimer);

					debounceTimer = setTimeout(() => {
						buscarPersonajes();
					}, 300);
				}));

			function buscarPersonajes() {
				let nombre = document.getElementById("fNombre").value || "";
				let juego = document.getElementById("fJuego").value || "";
				let puesto = document.getElementById("fPuesto").value || "";
				let estrellas = document.getElementById("fEstrellas").value || "";

				let url = `/usuario/buscarPersonajes?nombre=${encodeURIComponent(nombre)}&juego=${encodeURIComponent(juego)}&puesto=${encodeURIComponent(puesto)}&estrellas=${encodeURIComponent(estrellas)}`;

				console.log("üîç Buscando personajes con:", {nombre, juego, puesto, estrellas});
				console.log("üì° URL:", url);

				fetch(url)
					.then(res => {
						console.log("üì® Respuesta recibida, status:", res.status);
						if (!res.ok) {
							throw new Error('Error en la respuesta del servidor: ' + res.status);
						}
						return res.json();
					})
					.then(lista => {
						console.log("‚úÖ Datos JSON recibidos:", lista);
						console.log("üî¢ Cantidad de elementos:", lista.length);

						if (lista.length > 0) {
							console.log("üë§ Primer elemento:", lista[0]);
							console.log("‚≠ê Estrellas del primer elemento:", lista[0].estrellas);
						}

						actualizarTabla(lista);
					})
					.catch(error => {
						console.error('‚ùå Error en la b√∫squeda:', error);
						document.getElementById("noResults").style.display = "block";
						document.getElementById("noResults").textContent = "Error al cargar los datos: " + error.message;
					});
			}

			function actualizarTabla(lista) {
				let tbody = document.getElementById("tablaPersonajes");
				let noResults = document.getElementById("noResults");

				console.log("üîÑ Actualizando tabla con", lista.length, "elementos");

				tbody.classList.add("hide");

				setTimeout(() => {
					tbody.innerHTML = "";

					if (lista.length === 0) {
						noResults.style.display = "block";
						noResults.textContent = "No se encontraron resultados";
						console.log("‚ùå No hay resultados para mostrar");
					} else {
						noResults.style.display = "none";
						console.log("‚úÖ Mostrando", lista.length, "resultados");
					}

					lista.forEach(p => {
						console.log("üìù Procesando personaje:", p.nombre);

						let claseColor = "";
						let claseBrillo = "";

						if (p.puesto <= 10) {
							claseColor = "text-oro";
							claseBrillo = "brillo-oro";
						} else if (p.puesto <= 20) {
							claseColor = "text-plata";
							claseBrillo = "brillo-plata";
						} else if (p.puesto <= 30) {
							claseColor = "text-bronce";
							claseBrillo = "brillo-bronce";
						} else {
							claseColor = "text-verde";
							claseBrillo = "brillo-verde";
						}

						let estrellasHtml = "‚≠ê".repeat(p.estrellas || 0);

						// Asegurarse de que los datos existan
						const nombre = p.nombre || "Sin nombre";
						const imagen = p.imagen ? `/images/${p.imagen}` : "/images/default.jpg";
						const total = p.total || 0;
						const juegoNombre = p.juego ? p.juego.nombre : "Sin juego";
						const caracteristica = p.caracteristica || "Sin descripci√≥n";
						const id = p.id || "#";

						let row = `
			                <tr class="center text-white fade">
			                    <td><span class="${claseColor} fw-bold">${p.puesto}</span></td>
			                    <td>
			                        <img src="${imagen}" class="img-mini spin-slow ${claseBrillo}" alt="${nombre}">
			                    </td>
			                    <td class="${claseColor}">${nombre}</td>
			                    <td>
			                        <span style="font-size: 1.4rem;">${estrellasHtml}</span>
			                        <div style="margin-top: 2px; font-size: 70%;">(${total}%)</div>
			                    </td>
			                    <td class="${claseColor}">${juegoNombre}</td>
			                    <td>
			                        <a class="btn btn-info"
			                            data-nombre="${nombre}"
			                            data-img="${imagen}"
			                            data-calificacion="${p.estrellas || 0}"
			                            data-juego="${juegoNombre}"
			                            data-puesto="${p.puesto}"
			                            data-descripcion="${caracteristica}"
			                            onclick="mostrarDetalles(this)">
			                            <i class="bi bi-eye-fill" style="color: aliceblue;"></i>
			                        </a>
			                    </td>
			                    <td>
			                        <a class="btn btn-warning" href="/usuario/EditPerson/${id}">
			                            <i class="bi bi-pencil-fill" style="color: aliceblue;"></i>
			                        </a>
			                    </td>
			                    <td>
			                        <a class="btn btn-primary" href="/usuario/DeletePerson/${id}">
			                            <i class="bi bi-trash-fill" style="color: aliceblue;"></i>
			                        </a>
			                    </td>
			                </tr>
			            `;

						tbody.innerHTML += row;
					});

					tbody.classList.remove("hide");
					console.log("üéâ Tabla actualizada correctamente");

				}, 150);
			}        
		</script>
	</div>

</div>